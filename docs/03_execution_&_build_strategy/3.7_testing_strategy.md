# Phase 3.7 – Testing Strategy

> **Goal of this phase**
>
> Define **comprehensive testing approach** for EventFlow covering unit, integration, and end-to-end tests to ensure production quality.

---

## 1. Testing Philosophy

### 1.1 Testing Principles

* **Test behavior, not implementation**
* **Fast feedback loop** - Tests run quickly
* **Reliable tests** - No flaky tests
* **Maintainable** - Tests are code too
* **Coverage targets** - 80% code coverage (pragmatic)

### 1.2 Testing Pyramid

```
        /\
       /E2E\        ← Few, critical paths
      /------\
     /Integration\  ← Key workflows
    /------------\
   /   Unit Tests  \ ← Many, fast
  /----------------\
```

**Distribution:**
* Unit Tests: 70%
* Integration Tests: 25%
* E2E Tests: 5%

---

## 2. Backend Testing

### 2.1 Unit Tests

**Framework:** Jest + NestJS Testing Utilities

**What to Test:**
* Service methods (business logic)
* Utility functions
* Validators
* Transformers
* Error handling

**Example:**
```typescript
describe('EventService', () => {
  it('should create event with metadata', async () => {
    const event = await eventService.create({
      streamId: 'uuid',
      eventType: 'user_registered',
      payload: { userId: '123' },
    });
    
    expect(event.id).toBeDefined();
    expect(event.metadata.eventType).toBe('user_registered');
  });
});
```

**Coverage Target:** 80%+

---

### 2.2 Integration Tests

**Framework:** Jest + Supertest

**What to Test:**
* API endpoints (full request/response)
* Database operations
* Authentication flows
* Error scenarios

**Setup:**
* Test database (PostgreSQL)
* Test Redis instance
* Clean database before each test

**Example:**
```typescript
describe('POST /api/v1/streams/{id}/events', () => {
  it('should ingest event successfully', async () => {
    const response = await request(app)
      .post(`/api/v1/streams/${streamId}/events`)
      .set('X-API-Key', apiKey)
      .send({
        eventType: 'test_event',
        payload: { data: 'test' },
      });
    
    expect(response.status).toBe(202);
    expect(response.body.event_id).toBeDefined();
  });
});
```

**Coverage Target:** All API endpoints

---

### 2.3 Database Tests

**What to Test:**
* Schema migrations
* Foreign key constraints
* Indexes
* Data integrity

**Tools:**
* Prisma migration testing
* Database seed scripts (Prisma seed)

---

## 3. Frontend Testing

### 3.1 Unit Tests

**Framework:** Jest + React Testing Library

**What to Test:**
* Component rendering
* User interactions
* Custom hooks
* Utility functions

**Example:**
```typescript
describe('LoginForm', () => {
  it('should submit login form', async () => {
    render(<LoginForm />);
    
    fireEvent.change(screen.getByLabelText('Email'), {
      target: { value: 'test@example.com' },
    });
    fireEvent.click(screen.getByText('Login'));
    
    await waitFor(() => {
      expect(mockLogin).toHaveBeenCalled();
    });
  });
});
```

---

### 3.2 Integration Tests

**What to Test:**
* API integration
* Form submissions
* Navigation flows
* State management

**Tools:**
* MSW (Mock Service Worker) for API mocking
* React Query testing utilities

---

### 3.3 E2E Tests (Future)

**Framework:** Playwright or Cypress

**What to Test:**
* Critical user journeys:
  * User login → Create stream → Ingest event → View event
  * Create consumer group → Poll events → Commit offset

**Scope (MVP):**
* 5-10 critical paths
* Run in CI/CD before production deploy

---

## 4. Test Data Management

### 4.1 Test Fixtures

**Backend:**
* Factory functions for test data
* Database seeders
* Mock external services

**Frontend:**
* Mock API responses
* Test data generators

### 4.2 Test Isolation

* Each test is independent
* Clean database before each test
* No shared state between tests
* Parallel test execution

---

## 5. Test Organization

### 5.1 File Structure

```
backend/
├── src/
│   └── modules/
│       └── events/
│           ├── events.service.ts
│           ├── events.service.spec.ts  ← Unit tests
│           └── events.controller.spec.ts  ← Integration tests
│
└── test/
    ├── e2e/
    │   └── event-ingestion.e2e-spec.ts
    ├── fixtures/
    │   └── events.fixture.ts
    └── setup.ts

frontend/
├── components/
│   └── LoginForm/
│       ├── LoginForm.tsx
│       └── LoginForm.test.tsx
└── __tests__/
    └── utils.test.ts
```

---

## 6. Continuous Testing

### 6.1 Pre-Commit Hooks

**Tool:** Husky + lint-staged

**Actions:**
* Run linter
* Run unit tests (affected files only)
* Type checking

### 6.2 CI/CD Pipeline

**On Pull Request:**
1. Lint code
2. Type check
3. Run unit tests
4. Run integration tests
5. Check coverage

**On Merge to Main:**
* All above +
* E2E tests
* Performance tests (future)

---

## 7. Test Coverage

### 7.1 Coverage Tools

**Backend:** Jest coverage
**Frontend:** Jest + Istanbul

### 7.2 Coverage Targets

* **Overall:** 80%
* **Critical paths:** 95%+
* **Utilities:** 90%+
* **UI components:** 70%+ (pragmatic)

### 7.3 Coverage Reports

* Generated in CI/CD
* Uploaded to coverage service (Codecov)
* PR comments with coverage diff

---

## 8. Performance Testing (Future)

### 8.1 Load Testing

**Tools:** k6, Artillery, or Locust

**Scenarios:**
* Event ingestion throughput
* Concurrent consumer polling
* Database query performance

**Targets:**
* 1000 events/second (MVP)
* < 100ms p95 latency
* 99.9% success rate

---

## 9. Security Testing

### 9.1 Security Test Types

* **Authentication tests** - Invalid credentials
* **Authorization tests** - Unauthorized access
* **Input validation tests** - SQL injection, XSS
* **Rate limiting tests** - Exceed limits

### 9.2 Tools

* OWASP ZAP (future)
* Manual security reviews

---

## 10. Test Maintenance

### 10.1 Best Practices

* **Keep tests simple** - One assertion per test
* **Descriptive names** - `should_create_event_when_valid_payload_provided`
* **DRY principle** - Reusable test utilities
* **Update tests with code** - Don't let tests rot

### 10.2 Test Documentation

* README in test directories
* Examples for common patterns
* Troubleshooting guide

---

## 11. Testing Tools Summary

### 11.1 Backend

| Tool           | Purpose                |
| -------------- | ---------------------- |
| Jest           | Test runner            |
| Supertest      | HTTP testing           |
| Prisma         | Database access & migrations |
| Faker          | Test data generation   |

### 11.2 Frontend

| Tool                | Purpose                |
| ------------------- | ---------------------- |
| Jest                | Test runner            |
| React Testing Library | Component testing    |
| MSW                 | API mocking            |
| Playwright          | E2E testing (future)   |

---

## 12. Test Execution

### 12.1 Local Development

```bash
# Backend
npm run test              # Unit tests
npm run test:integration # Integration tests
npm run test:e2e         # E2E tests
npm run test:watch       # Watch mode
npm run test:coverage    # Coverage report

# Frontend
npm run test             # Unit tests
npm run test:watch       # Watch mode
npm run test:coverage    # Coverage report
```

### 12.2 CI/CD

* Tests run automatically on PR
* Failures block merge
* Coverage reports generated
* Test results visible in PR

---

## 13. Summary

EventFlow testing strategy provides:

* ✅ Comprehensive test coverage (unit, integration, E2E)
* ✅ Fast feedback loop
* ✅ Reliable, maintainable tests
* ✅ CI/CD integration
* ✅ Coverage tracking
* ✅ Security testing
* ✅ Performance testing (future)

This ensures **high-quality, production-ready code** with confidence in deployments.
