# Phase 3.8 – CI/CD Pipeline Design

> **Goal of this phase**
>
> Define **complete CI/CD pipeline** for automated testing, building, and deployment of EventFlow to ensure reliable, repeatable releases.

---

## 1. CI/CD Philosophy

### 1.1 Principles

* **Automate everything** - No manual deployment steps
* **Fail fast** - Catch issues early
* **Deploy often** - Small, frequent releases
* **Rollback ready** - Quick recovery from failures
* **Environment parity** - Dev → Staging → Production

---

## 2. Pipeline Overview

### 2.1 Pipeline Stages

```
Code Push
  ↓
Lint & Type Check
  ↓
Unit Tests
  ↓
Integration Tests
  ↓
Build Docker Images
  ↓
Security Scan
  ↓
Deploy to Staging
  ↓
E2E Tests (Staging)
  ↓
Deploy to Production
  ↓
Smoke Tests
```

---

## 3. CI/CD Tool: GitHub Actions

### 3.1 Why GitHub Actions

* Native GitHub integration
* Free for public repos
* YAML-based configuration
* Built-in secrets management
* Matrix builds support

---

## 4. Pipeline Configuration

### 4.1 Workflow Files Structure

```
.github/
└── workflows/
    ├── ci.yml              # Continuous Integration
    ├── cd-staging.yml      # Staging deployment
    ├── cd-production.yml   # Production deployment
    └── security-scan.yml  # Security scanning
```

---

## 5. Continuous Integration (CI)

### 5.1 CI Workflow (`ci.yml`)

**Triggers:**
* Push to any branch
* Pull request opened/updated

**Stages:**

#### Stage 1: Code Quality
```yaml
- name: Lint Code
  run: npm run lint

- name: Type Check
  run: npm run type-check
```

#### Stage 2: Backend Tests
```yaml
- name: Setup PostgreSQL
  uses: docker/setup-postgres-action@v1
  with:
    postgres-version: '15'

- name: Run Unit Tests
  run: npm run test:unit

- name: Run Integration Tests
  run: npm run test:integration

- name: Generate Coverage
  run: npm run test:coverage
```

#### Stage 3: Frontend Tests
```yaml
- name: Install Dependencies
  run: cd frontend && npm ci

- name: Run Tests
  run: cd frontend && npm run test

- name: Build Frontend
  run: cd frontend && npm run build
```

#### Stage 4: Build Docker Images
```yaml
- name: Build Backend Image
  run: docker build -t eventflow-backend:${{ github.sha }} ./backend

- name: Build Frontend Image
  run: docker build -t eventflow-frontend:${{ github.sha }} ./frontend
```

**Outputs:**
* Test results
* Coverage reports
* Build artifacts

---

## 6. Continuous Deployment (CD)

### 6.1 Staging Deployment (`cd-staging.yml`)

**Triggers:**
* Merge to `develop` branch
* Manual workflow dispatch

**Stages:**

#### Stage 1: Build & Push Images
```yaml
- name: Build and Push to ECR
  env:
    AWS_REGION: eu-central-1
    ECR_REPOSITORY: eventflow-backend
  run: |
    aws ecr get-login-password | docker login --username AWS --password-stdin $ECR_REGISTRY
    docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG ./backend
    docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
```

#### Stage 2: Deploy Infrastructure
```yaml
- name: Deploy with Terraform
  run: |
    cd infrastructure
    terraform init
    terraform plan -out=tfplan
    terraform apply tfplan
```

#### Stage 3: Deploy Application
```yaml
- name: Update ECS Service
  run: |
    aws ecs update-service \
      --cluster eventflow-staging \
      --service backend \
      --force-new-deployment
```

#### Stage 4: Run E2E Tests
```yaml
- name: Run E2E Tests
  run: npm run test:e2e -- --env=staging
```

**Rollback:**
* If E2E tests fail, automatically rollback to previous version

---

### 6.2 Production Deployment (`cd-production.yml`)

**Triggers:**
* Merge to `main` branch
* Manual approval required

**Stages:**

#### Stage 1: Pre-Deployment Checks
```yaml
- name: Check Staging Health
  run: |
    # Verify staging is healthy
    curl -f https://staging.eventflow.com/health || exit 1
```

#### Stage 2: Build & Tag
```yaml
- name: Build Production Images
  run: |
    docker build -t eventflow-backend:v${{ github.run_number }} ./backend
    docker tag eventflow-backend:v${{ github.run_number }} eventflow-backend:latest
```

#### Stage 3: Deploy (Blue-Green)
```yaml
- name: Deploy to Production
  run: |
    # Deploy new version alongside existing
    # Run smoke tests
    # Switch traffic if healthy
    # Keep old version for rollback
```

#### Stage 4: Post-Deployment
```yaml
- name: Smoke Tests
  run: npm run test:smoke -- --env=production

- name: Monitor Metrics
  run: |
    # Wait 5 minutes
    # Check error rates
    # Verify event ingestion
```

**Manual Approval:**
* Requires approval from maintainer
* Deployment can be cancelled

---

## 7. Infrastructure as Code

### 7.1 Terraform Structure

```
infrastructure/
├── environments/
│   ├── staging/
│   │   ├── main.tf
│   │   ├── variables.tf
│   │   └── terraform.tfvars
│   └── production/
│       ├── main.tf
│       ├── variables.tf
│       └── terraform.tfvars
├── modules/
│   ├── vpc/
│   ├── rds/
│   ├── ecs/
│   └── alb/
└── main.tf
```

### 7.2 Terraform in CI/CD

```yaml
- name: Terraform Plan
  run: |
    terraform init
    terraform plan -out=tfplan

- name: Terraform Apply
  if: github.ref == 'refs/heads/main'
  run: terraform apply tfplan
```

---

## 8. Docker Image Management

### 8.1 Image Tagging Strategy

* **Commit SHA:** `eventflow-backend:abc123`
* **Branch:** `eventflow-backend:develop`
* **Version:** `eventflow-backend:v1.0.0`
* **Latest:** `eventflow-backend:latest` (production only)

### 8.2 Image Registry

* **AWS ECR** (Elastic Container Registry)
* Private repositories
* Image scanning enabled
* Retention policy: Keep last 10 images

---

## 9. Database Migrations

### 9.1 Migration Strategy

**Automated:**
* Migrations run automatically on deployment
* Prisma migrations executed via `prisma migrate deploy` in container startup

**Process:**
```yaml
- name: Run Migrations
  run: |
    npx prisma migrate deploy
    npx prisma generate
    # Verify migration success
```

**Rollback:**
* Manual database restore if needed
* Migrations are forward-only (no down migrations)

---

## 10. Secrets Management

### 10.1 GitHub Secrets

**Stored Secrets:**
* `AWS_ACCESS_KEY_ID`
* `AWS_SECRET_ACCESS_KEY`
* `DATABASE_URL`
* `JWT_SECRET`
* `API_KEYS_SECRET`

**Usage:**
```yaml
- name: Deploy
  env:
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
    JWT_SECRET: ${{ secrets.JWT_SECRET }}
```

### 10.2 AWS Secrets Manager

* Production secrets in AWS Secrets Manager
* Retrieved at runtime by application
* Automatic rotation (where supported)

---

## 11. Security Scanning

### 11.1 Dependency Scanning

```yaml
- name: Security Audit
  run: npm audit --audit-level=high

- name: Snyk Scan
  uses: snyk/actions/node@master
  with:
    args: --severity-threshold=high
```

### 11.2 Container Scanning

```yaml
- name: Scan Docker Image
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: eventflow-backend:${{ github.sha }}
    format: 'sarif'
```

---

## 12. Notifications

### 12.1 Slack Integration

```yaml
- name: Notify Slack
  if: failure()
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    text: 'Deployment failed!'
```

### 12.2 Email Notifications

* Production deployments
* Failed deployments
* Security alerts

---

## 13. Rollback Strategy

### 13.1 Automatic Rollback

**Triggers:**
* Health check failures
* Error rate spike (> 5%)
* E2E test failures

**Process:**
1. Detect failure
2. Route traffic back to previous version
3. Notify team
4. Investigate issue

### 13.2 Manual Rollback

```bash
# Revert to previous ECS task definition
aws ecs update-service \
  --cluster eventflow-production \
  --service backend \
  --task-definition eventflow-backend:previous
```

---

## 14. Deployment Environments

### 14.1 Environment Promotion

```
Local Development
  ↓ (PR)
Staging
  ↓ (Merge to main)
Production
```

### 14.2 Environment Configuration

* Environment variables per environment
* Separate AWS accounts (or VPCs)
* Separate databases
* Same codebase, different configs

---

## 15. Monitoring Deployment

### 15.1 Deployment Metrics

* Deployment duration
* Success/failure rate
* Rollback frequency
* Time to recovery

### 15.2 Post-Deployment Checks

* Health endpoint check
* Event ingestion test
* Database connectivity
* API response times

---

## 16. Pipeline Summary

### 16.1 CI Pipeline (Every PR)

1. ✅ Lint & type check
2. ✅ Unit tests
3. ✅ Integration tests
4. ✅ Build Docker images
5. ✅ Security scan

**Duration:** ~10-15 minutes

### 16.2 CD Pipeline (Staging)

1. ✅ Build & push images
2. ✅ Deploy infrastructure
3. ✅ Deploy application
4. ✅ Run E2E tests

**Duration:** ~20-30 minutes

### 16.3 CD Pipeline (Production)

1. ✅ Pre-deployment checks
2. ✅ Build & tag images
3. ✅ Blue-green deployment
4. ✅ Smoke tests
5. ✅ Monitor metrics

**Duration:** ~30-45 minutes (with approval)

---

## 17. Best Practices

### 17.1 Pipeline Optimization

* **Parallel execution** - Run tests in parallel
* **Caching** - Cache dependencies
* **Conditional steps** - Skip unnecessary steps
* **Fast feedback** - Fail fast on errors

### 17.2 Documentation

* Pipeline documentation in README
* Deployment runbooks
* Troubleshooting guide
* Rollback procedures

---

## 18. Summary

EventFlow CI/CD pipeline provides:

* ✅ Automated testing (unit, integration, E2E)
* ✅ Automated builds (Docker images)
* ✅ Automated deployments (staging & production)
* ✅ Security scanning
* ✅ Infrastructure as code
* ✅ Rollback capabilities
* ✅ Environment promotion
* ✅ Monitoring & notifications

This ensures **reliable, repeatable, and safe deployments** to production.
