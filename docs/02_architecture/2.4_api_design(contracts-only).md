# Phase 2.4 – API Design (Contracts Only)

## 1. Purpose

This document defines the **API contracts** for EventFlow.

The focus is on:

* Endpoint structure
* Request & response schemas
* Authentication expectations
* Error handling conventions

❗ No implementation details are included.

---

## 2. API Design Principles

* **RESTful design**
* **Versioned APIs** (`/api/v1`)
* **Stateless requests**
* **Clear separation** between admin, producer, and internal APIs
* **Explicit error responses**

---

## 3. Authentication Model

### 3.1 Auth Mechanism

* JWT-based authentication
* API Key authentication for event producers

### 3.2 Auth Types by Actor

| Actor                  | Auth Method   |
| ---------------------- | ------------- |
| Admin / Dashboard User | JWT           |
| Event Producer         | API Key       |
| Internal Consumers     | Service Token |

---

## 4. API Domains

EventFlow exposes APIs under the following domains:

* Auth APIs
* Producer Management APIs
* Event Ingestion APIs
* Event Query APIs
* Consumer APIs
* Health & System APIs

---

## 5. Auth APIs

### POST /api/v1/auth/login

**Purpose:**
Authenticate dashboard user.

**Request:**

```json
{
  "email": "string",
  "password": "string"
}
```

**Response:**

```json
{
  "access_token": "jwt",
  "refresh_token": "jwt",
  "expires_in": 3600
}
```

---

## 6. Organization & API Key Management APIs

### POST /api/v1/organizations

**Purpose:**
Create a new organization (admin only).

**Auth:** JWT (Admin)

**Request:**

```json
{
  "name": "string"
}
```

**Response:**

```json
{
  "id": "uuid",
  "name": "string",
  "created_at": "timestamp"
}
```

---

### POST /api/v1/api-keys

**Purpose:**
Generate a new API key for event producers.

**Auth:** JWT

**Request:**

```json
{
  "label": "string",
  "organization_id": "uuid"
}
```

**Response:**

```json
{
  "id": "uuid",
  "api_key": "ef_live_...",  // Only shown once
  "label": "string",
  "created_at": "timestamp"
}
```

---

## 7. Event Stream Management APIs

### POST /api/v1/streams

**Purpose:**
Create a new event stream.

**Auth:** JWT

**Request:**

```json
{
  "name": "string",
  "schema": { }  // Optional JSON schema for validation
}
```

**Response:**

```json
{
  "id": "uuid",
  "name": "string",
  "organization_id": "uuid",
  "created_at": "timestamp"
}
```

---

### GET /api/v1/streams

**Purpose:**
List all streams for authenticated organization.

**Auth:** JWT

**Response:**

```json
{
  "items": [
    {
      "id": "uuid",
      "name": "string",
      "event_count": 1000,
      "created_at": "timestamp"
    }
  ],
  "total": 5
}
```

---

## 8. Event Ingestion APIs

### POST /api/v1/streams/{stream_id}/events

**Purpose:**
Ingest a new event into EventFlow.

**Auth:** API Key (in header: `X-API-Key`)

**Request:**

```json
{
  "event_type": "string",
  "event_version": 1,
  "payload": { },
  "context": {  // Optional
    "trace_id": "string",
    "correlation_id": "string"
  }
}
```

**Response:**

```json
{
  "event_id": "uuid",
  "status": "ACCEPTED",
  "received_at": "timestamp"
}
```

**Error Responses:**

```json
{
  "error_code": "VALIDATION_ERROR",
  "message": "Event payload does not match stream schema",
  "request_id": "uuid",
  "details": {
    "field": "payload.user_id",
    "reason": "required field missing"
  }
}
```

---

## 9. Event Query APIs

### GET /api/v1/streams/{stream_id}/events

**Purpose:**
Query stored events for a stream.

**Auth:** JWT

**Query Params:**

* `from` - ISO 8601 timestamp (optional)
* `to` - ISO 8601 timestamp (optional)
* `limit` - Number of events (default: 50, max: 1000)
* `cursor` - Pagination cursor (optional)

**Response:**

```json
{
  "items": [
    {
      "id": "uuid",
      "event_type": "string",
      "payload": { },
      "metadata": {
        "occurred_at": "timestamp",
        "source": "string",
        "event_version": 1
      },
      "created_at": "timestamp"
    }
  ],
  "pagination": {
    "next_cursor": "string",
    "has_more": true
  },
  "total": 100
}
```

---

## 10. Consumer Group APIs

### POST /api/v1/streams/{stream_id}/consumer-groups

**Purpose:**
Register a new consumer group for a stream.

**Auth:** JWT

**Request:**

```json
{
  "name": "string"
}
```

**Response:**

```json
{
  "id": "uuid",
  "name": "string",
  "stream_id": "uuid",
  "created_at": "timestamp"
}
```

---

### GET /api/v1/streams/{stream_id}/consumer-groups/{group_id}/events

**Purpose:**
Fetch next batch of events for a consumer group (polling pattern).

**Auth:** JWT or Service Token

**Query Params:**

* `limit` - Number of events (default: 100, max: 1000)
* `timeout` - Long polling timeout in seconds (default: 30)

**Response:**

```json
{
  "events": [
    {
      "id": "uuid",
      "payload": { },
      "metadata": { }
    }
  ],
  "next_offset": "uuid"  // Last event ID for offset commit
}
```

---

### POST /api/v1/streams/{stream_id}/consumer-groups/{group_id}/offsets

**Purpose:**
Commit consumer group offset (acknowledge processing).

**Auth:** JWT or Service Token

**Request:**

```json
{
  "last_event_id": "uuid"
}
```

**Response:**

```json
{
  "status": "COMMITTED",
  "offset": "uuid",
  "committed_at": "timestamp"
}
```

---

## 11. Error Handling

### Standard Error Format

All errors follow this structure:

```json
{
  "error_code": "string",
  "message": "string",
  "request_id": "uuid",
  "details": { }  // Optional additional context
}
```

### Error Code Catalog

| Error Code              | HTTP Status | Description                          |
| ----------------------- | ----------- | ------------------------------------- |
| `VALIDATION_ERROR`      | 400         | Request validation failed              |
| `UNAUTHORIZED`          | 401         | Missing or invalid authentication      |
| `FORBIDDEN`             | 403         | Insufficient permissions               |
| `NOT_FOUND`             | 404         | Resource not found                    |
| `RATE_LIMIT_EXCEEDED`   | 429         | Too many requests                     |
| `INTERNAL_ERROR`        | 500         | Internal server error                  |
| `SERVICE_UNAVAILABLE`   | 503         | Service temporarily unavailable        |
| `SCHEMA_MISMATCH`       | 400         | Event payload doesn't match stream schema |

### Rate Limiting

Rate limits are communicated via headers:

```
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 950
X-RateLimit-Reset: 1640995200
```

When rate limit exceeded, response includes:

```json
{
  "error_code": "RATE_LIMIT_EXCEEDED",
  "message": "Rate limit exceeded. Try again after 2022-01-01T00:00:00Z",
  "request_id": "uuid",
  "retry_after": 60
}
```

---

## 11. Health & System APIs

### GET /api/v1/health

**Purpose:**
System health check.

**Response:**

```json
{
  "status": "UP"
}
```

---

## 12. Versioning Strategy

* Breaking changes → new API version
* Backward compatibility within same version