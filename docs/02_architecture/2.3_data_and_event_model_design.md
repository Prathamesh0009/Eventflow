# Phase 2.3 – Data & Event Model Design

## 1. Purpose

This document defines **how data is structured and stored** in EventFlow, with a strong focus on **event design**, **immutability**, and **future analytics readiness**.

The goal is to design data models that:

* Are simple for MVP
* Reflect real-world event-driven systems
* Can evolve into analytics, BI, or ML pipelines later

---

## 2. Core Data Philosophy

EventFlow follows an **event-first data philosophy**:

* Events are **immutable**
* Events are the **source of truth**
* Derived data can be rebuilt from events
* State is secondary, events are primary

This aligns with:

* Event Sourcing concepts
* Auditability
* Analytics friendliness

---

## 3. Event Model (Core Concept)

### 3.1 What Is an Event?

An event represents:

> “Something that happened in the system at a specific point in time.”

Examples:

* `user_registered`
* `order_created`
* `payment_failed`
* `service_called`

---

### 3.2 Event Structure (Logical Model)

Each event consists of three layers:

1. **Metadata** – system-level information
2. **Payload** – business data
3. **Context** – optional tracing & correlation data

---

### 3.3 Event Schema (Logical)

```json
{
  "event_id": "uuid",
  "event_type": "string",
  "event_version": 1,
  "occurred_at": "timestamp",
  "source": "service-name",
  "producer_id": "string",
  "payload": { },
  "context": {
    "trace_id": "string",
    "correlation_id": "string"
  }
}
```

---

## 4. Database Design (PostgreSQL)

### 4.1 Core Tables Overview

| Table              | Purpose                    |
| ------------------ | -------------------------- |
| producers          | Registered event producers |
| events             | Immutable event store      |
| event_dispatch_log | Tracks dispatch attempts   |
| consumers          | Internal consumers         |
| consumer_offsets   | Tracks consumption state   |

---

## 5. Table Designs (Logical)

### 5.1 producers

**Purpose:**
Stores systems or services that emit events.

**Key Fields:**

* producer_id (PK)
* name
* api_key
* created_at

---

### 5.2 events (Core Event Store)

**Purpose:**
Stores all events immutably.

**Key Fields:**

* event_id (PK)
* event_type
* event_version
* occurred_at
* source
* producer_id (FK)
* payload (JSONB)
* context (JSONB)

**Design Notes:**

* Append-only
* No UPDATEs
* Indexed on event_type, occurred_at

---

### 5.3 event_dispatch_log

**Purpose:**
Tracks delivery attempts to consumers.

**Key Fields:**

* dispatch_id (PK)
* event_id (FK)
* consumer_id
* status (PENDING / SUCCESS / FAILED)
* retry_count
* last_attempt_at

---

### 5.4 consumers

**Purpose:**
Represents internal event consumers.

**Key Fields:**

* consumer_id (PK)
* name
* subscribed_event_types
* created_at

---

### 5.5 consumer_offsets

**Purpose:**
Tracks consumption progress per consumer.

**Key Fields:**

* consumer_id (PK)
* last_processed_event_id
* updated_at

---

## 6. Why This Model Works

* Simple relational core
* JSON payload allows flexibility
* Strong audit trail
* Easy analytics extraction later

---

## 7. Analytics & Data Science Open End

This model enables:

* ETL to data warehouse
* Event aggregation
* Funnel analysis
* Time-series analytics
* ML feature generation

Without changing core architecture.

---

## 8. Trade-offs (Explicit)

Accepted trade-offs:

* No strict schema enforcement on payload (MVP)
* Potential payload inconsistency

Mitigation (future):

* Schema registry
* Versioned payload validation