# Phase 2.6 – Security Design

## 1. Purpose

This document defines **comprehensive security measures** for EventFlow, covering authentication, authorization, data protection, and operational security.

Security is treated as a first-class concern, not an afterthought.

---

## 2. Security Principles

* **Defense in depth** - Multiple layers of security
* **Least privilege** - Minimal access required
* **Zero trust** - Verify all requests
* **Encryption everywhere** - Data at rest and in transit
* **Audit everything** - Log all security-relevant events

---

## 3. Authentication

### 3.1 User Authentication (Dashboard)

**Method:** JWT (JSON Web Tokens) with refresh tokens

**Implementation:**
* **Access Token:**
  * Algorithm: `HS256` or `RS256`
  * Expiration: 15 minutes
  * Claims: `sub` (user_id), `org_id`, `role`, `iat`, `exp`
* **Refresh Token:**
  * Expiration: 7 days
  * Stored in HTTP-only cookie
  * Rotated on each use

**Password Security:**
* Hashing: **Argon2id** (industry standard)
* Salt: Auto-generated per password
* Minimum requirements:
  * 12+ characters
  * At least one uppercase, lowercase, number, special char
* Password reset: Time-limited token (15 minutes)

**Example Flow:**
```
1. User submits email + password
2. Backend hashes password with Argon2id
3. Compare with stored hash
4. Generate JWT access + refresh tokens
5. Return tokens to frontend
```

---

### 3.2 API Key Authentication (Producers)

**Method:** API Keys with HMAC validation

**Key Format:**
```
ef_live_<random_32_chars>
ef_test_<random_32_chars>  (for staging)
```

**Storage:**
* Keys stored as **hashed values** (bcrypt)
* Original key shown **only once** during creation
* Keys cannot be retrieved after creation

**Validation:**
1. Extract API key from `X-API-Key` header
2. Hash incoming key
3. Compare with stored hash in `api_keys` table
4. Check `revoked_at` is null
5. Resolve `org_id` from key

**Rate Limiting:**
* Per API key: 1000 requests/minute
* Burst: 100 requests/second
* Headers returned: `X-RateLimit-*`

---

### 3.3 Service Token Authentication (Internal)

**Method:** Long-lived service tokens for internal consumers

**Format:**
```
svc_<service_name>_<random_24_chars>
```

**Usage:**
* Internal service-to-service communication
* Consumer group polling
* Not exposed to external clients

---

## 4. Authorization

### 4.1 Role-Based Access Control (RBAC)

**Roles:**
* **Admin:**
  * Full access to organization
  * Create/manage users
  * Create/manage API keys
  * Create/manage streams
  * View all events
* **Viewer:**
  * Read-only access
  * View events
  * View streams
  * Cannot create/modify resources

**Implementation:**
* Roles stored in `users.role` column
* Guards check role before allowing operations
* Frontend hides UI elements based on role

---

### 4.2 Resource-Level Authorization

**Organization Isolation:**
* All resources scoped to `org_id`
* Users can only access their organization's data
* API keys bound to specific organization
* Streams belong to organizations

**Enforcement:**
* Every database query includes `org_id` filter
* API endpoints validate `org_id` matches authenticated user
* No cross-organization data leakage possible

---

## 5. Data Protection

### 5.1 Encryption at Rest

**Database (RDS):**
* Encryption enabled (AES-256)
* Encryption key managed by AWS KMS
* All data encrypted automatically

**Application Secrets:**
* Stored in **AWS Secrets Manager**
* Encrypted with KMS
* Rotated automatically (90 days)

**Backups:**
* RDS snapshots encrypted
* S3 backups encrypted (SSE-S3 or SSE-KMS)

---

### 5.2 Encryption in Transit

**HTTPS/TLS:**
* All API endpoints use TLS 1.2+
* Certificate managed by AWS Certificate Manager (ACM)
* HSTS headers enabled
* No HTTP endpoints exposed

**Database Connections:**
* PostgreSQL connections use SSL/TLS
* Certificate validation required

**Internal Communication:**
* Service-to-service: TLS within VPC
* Load balancer terminates TLS

---

### 5.3 Sensitive Data Handling

**Passwords:**
* Never logged
* Never returned in API responses
* Hashed with Argon2id

**API Keys:**
* Hashed before storage
* Original key shown only once
* Never logged in full (only prefix)

**Event Payloads:**
* May contain sensitive data
* No automatic PII detection (MVP)
* **Future:** PII masking/redaction

---

## 6. Secret Management

### 6.1 AWS Secrets Manager

**Secrets Stored:**
* Database credentials
* JWT signing keys
* Third-party API keys
* Encryption keys

**Access:**
* IAM roles for services
* Automatic rotation (where supported)
* Version history maintained

**Local Development:**
* `.env` file (git-ignored)
* `.env.example` template provided
* Never commit secrets

---

## 7. Input Validation & Sanitization

### 7.1 API Input Validation

**Schema Validation:**
* All requests validated against DTOs (NestJS)
* JSON schema validation for event payloads
* Type checking (TypeScript)

**SQL Injection Prevention:**
* Parameterized queries only
* ORM (TypeORM) prevents raw SQL
* No string concatenation in queries

**XSS Prevention:**
* Frontend: React auto-escapes
* API: No HTML in responses (JSON only)
* Content-Type: `application/json`

---

## 8. Rate Limiting

### 8.1 Implementation

**Tool:** Redis-based rate limiting

**Limits:**
* **API Keys:** 1000 req/min, 100 req/sec burst
* **JWT Users:** 500 req/min, 50 req/sec burst
* **Public Endpoints:** 100 req/min

**Headers:**
```
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 950
X-RateLimit-Reset: 1640995200
```

**Response on Exceed:**
* HTTP 429 Too Many Requests
* `Retry-After` header
* Error body with details

---

## 9. Security Headers

### 9.1 HTTP Security Headers

All responses include:

```
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Content-Security-Policy: default-src 'self'
Referrer-Policy: strict-origin-when-cross-origin
```

---

## 10. CORS Policy

### 10.1 Configuration

**Allowed Origins:**
* Production: Specific domain(s) only
* Staging: Staging domain + localhost (dev)
* Development: All origins (dev only)

**Allowed Methods:**
* GET, POST, PUT, DELETE, OPTIONS

**Allowed Headers:**
* Authorization, Content-Type, X-API-Key

**Credentials:**
* Cookies allowed for same-origin requests

---

## 11. Audit Logging

### 11.1 Security Events Logged

* Authentication attempts (success/failure)
* API key usage
* Authorization failures
* Password changes
* API key creation/revocation
* User role changes
* Sensitive data access

### 11.2 Log Format

```json
{
  "timestamp": "2026-01-24T10:00:00Z",
  "event_type": "AUTH_FAILURE",
  "user_id": "uuid",
  "ip_address": "1.2.3.4",
  "user_agent": "Mozilla/5.0...",
  "request_id": "uuid",
  "details": {
    "reason": "invalid_password"
  }
}
```

---

## 12. Vulnerability Management

### 12.1 Dependency Scanning

* **npm audit** - Run in CI/CD
* **Snyk** or **Dependabot** - Automated scanning
* **Update policy:** Security patches within 48 hours

### 12.2 Security Testing

* **OWASP Top 10** - Regular review
* **Penetration testing** - Annual (future)
* **Code reviews** - Security-focused

---

## 13. Incident Response

### 13.1 Security Incident Procedure

1. **Detection:** Automated alerts + manual reports
2. **Containment:** Isolate affected systems
3. **Investigation:** Review logs, identify scope
4. **Remediation:** Fix vulnerability, rotate secrets
5. **Communication:** Notify affected users (if required)
6. **Post-mortem:** Document and improve

### 13.2 Breach Notification

* GDPR compliance (if applicable)
* User notification within 72 hours
* Regulatory reporting (if required)

---

## 14. Compliance Considerations

### 14.1 GDPR (If Applicable)

* Data minimization
* Right to access
* Right to deletion
* Data portability
* Privacy by design

### 14.2 Data Retention

* Events: Configurable retention (default: 90 days)
* Logs: 30 days
* Backups: 7 days
* User data: Until account deletion

---

## 15. Future Security Enhancements

* **2FA/MFA** - Multi-factor authentication
* **SSO** - Single sign-on integration
* **IP Whitelisting** - For API keys
* **Webhook signatures** - For event delivery
* **PII detection** - Automatic masking
* **Anomaly detection** - Unusual access patterns

---

## 16. Summary

EventFlow implements security at multiple layers:

* ✅ Strong authentication (JWT + API keys)
* ✅ Role-based authorization
* ✅ Encryption (at rest + in transit)
* ✅ Secure secret management
* ✅ Input validation
* ✅ Rate limiting
* ✅ Security headers
* ✅ Audit logging

This provides a **production-grade security foundation** that can be enhanced as requirements grow.
