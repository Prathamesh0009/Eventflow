// PURPOSE: EventFlow production schema — organizations, users, API keys, event streams,
//          events, consumer groups, offsets, and dead-letter events.
// USE: Run `npx prisma generate` after changes; run `npx prisma migrate dev` to apply.
// NEED: Required by Phase 1 (Database & Infrastructure); single source of truth for DB.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // URL is set in prisma.config.ts (Prisma 7)
}

// --- Tenant isolation (Phase 3.3 §4.1) ---
model Organization {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  isActive  Boolean  @default(true) @map("is_active")

  users        User[]
  apiKeys      ApiKey[]
  eventStreams EventStream[]

  @@map("organizations")
}

// --- Dashboard users (Phase 3.3 §4.2) ---
model User {
  id           String   @id @default(uuid())
  orgId        String   @map("org_id")
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         String   // admin | viewer
  createdAt    DateTime @default(now()) @map("created_at")
  isActive     Boolean  @default(true) @map("is_active")

  organization Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@map("users")
}

// --- Producer API keys (Phase 3.3 §4.3) ---
model ApiKey {
  id        String    @id @default(uuid())
  orgId     String    @map("org_id")
  keyHash   String    @map("key_hash")
  label     String?
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  organization Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@map("api_keys")
}

// --- Event streams / topics (Phase 3.3 §4.4) ---
model EventStream {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  name      String
  schema    Json?    // expected payload schema (JSONB)
  createdAt DateTime @default(now()) @map("created_at")
  isActive  Boolean  @default(true) @map("is_active")

  organization   Organization    @relation(fields: [orgId], references: [id])
  events         Event[]
  consumerGroups ConsumerGroup[]

  @@unique([orgId, name])
  @@map("event_streams")
}

// --- Append-only event store (Phase 3.3 §4.5) ---
model Event {
  id        String   @id @default(uuid())
  streamId  String   @map("stream_id")
  payload   Json
  metadata  Json?    // system metadata (JSONB)
  createdAt DateTime @default(now()) @map("created_at")

  stream EventStream @relation(fields: [streamId], references: [id])
  consumerOffsets ConsumerOffset[]

  @@index([streamId, createdAt])
  @@map("events")
}

// --- Consumer groups (Phase 3.3 §4.6) ---
model ConsumerGroup {
  id        String   @id @default(uuid())
  streamId  String   @map("stream_id")
  name      String
  createdAt DateTime @default(now()) @map("created_at")

  stream  EventStream    @relation(fields: [streamId], references: [id])
  offset  ConsumerOffset?

  @@unique([streamId, name])
  @@map("consumer_groups")
}

// --- Consumption progress (Phase 3.3 §4.7) ---
model ConsumerOffset {
  id             String   @id @default(uuid())
  consumerGroupId String  @unique @map("consumer_group_id")
  lastEventId    String   @map("last_event_id")
  updatedAt      DateTime @updatedAt @map("updated_at")

  consumerGroup ConsumerGroup @relation(fields: [consumerGroupId], references: [id])
  lastEvent     Event          @relation(fields: [lastEventId], references: [id])

  @@map("consumer_offsets")
}

// --- Failed events / DLQ (Phase 3.3 §4.8) ---
model DeadLetterEvent {
  id       String   @id @default(uuid())
  eventId  String   @map("event_id")
  reason   String   @db.Text
  payload  Json
  failedAt DateTime @default(now()) @map("failed_at")

  @@index([eventId])
  @@map("dead_letter_events")
}
